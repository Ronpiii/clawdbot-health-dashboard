#!/usr/bin/env node
/**
 * arc - unified CLI for workspace tools
 * 
 * usage:
 *   arc search <query>     - search memory
 *   arc status             - workspace status
 *   arc check              - heartbeat check
 *   arc note <text>        - quick note
 *   arc task <cmd> [args]  - task management
 *   arc summary [--post]   - daily summary
 *   arc post <channel> <msg> - discord post
 *   arc compress [days]    - analyze old logs
 *   arc index              - rebuild search index
 */

import { spawn } from 'child_process';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

const SCRIPTS = {
  niche: 'niche.mjs',
  search: 'memory-index.mjs',
  status: 'status.mjs',
  check: 'heartbeat-check.mjs',
  note: 'note.mjs',
  idea: 'idea.mjs',
  today: 'today.mjs',
  week: 'week.mjs',
  recap: 'recap.mjs',
  timeline: 'timeline.mjs',
  morning: 'morning.mjs',
  project: 'project.mjs',
  standup: 'standup.mjs',
  task: 'task.mjs',
  summary: 'daily-summary.mjs',
  post: 'discord-post.mjs',
  compress: 'compress-logs.mjs',
  index: 'memory-index.mjs',
  maintain: 'auto-maintenance.mjs',
  analytics: 'search-analytics.mjs',
  reflect: 'reflect.mjs',
  test: 'test-toolkit.mjs',
  goals: 'goals.mjs',
  commit: 'auto-commit.mjs',
  audit: 'audit-skill.mjs',
  pr: 'pr-summary.mjs',
  errors: 'error-tracker.mjs',
  todo: 'todo.mjs',
  triage: 'triage.mjs',
  changelog: 'changelog.mjs',
  learn: 'learn.mjs',
  streak: 'streak.mjs',
  pipeline: 'pipeline.mjs',
  month: 'month.mjs',
  blockers: 'blockers.mjs',
  git: 'git-repos.mjs',
  deps: 'deps-check.mjs',
  snip: 'snip.mjs',
  snippet: 'snip.mjs',
  snippets: 'snip.mjs',
  shield: 'shield.mjs',
  diff: 'diff.mjs',
  wins: 'wins.mjs',
  health: 'health.mjs',
  context: 'context-gen.mjs',
  ctx: 'context-gen.mjs',
  focus: 'focus.mjs',
  clean: 'clean.mjs',
  env: 'env-audit.mjs',
  envs: 'env-audit.mjs',
  pulse: 'pulse.mjs',
  ping: 'pulse.mjs',
  uptime: 'pulse.mjs',
  fortune: 'fortune.mjs',
  wisdom: 'fortune.mjs',
  orbit: 'orbit.mjs',
  momentum: 'orbit.mjs'
};

const HELP = `
arc - unified CLI for workspace tools

Commands:
  niche <topic>         30-day niche research (Reddit, HN, X)
  search <query>        Search memory (keyword index)
  status                Show workspace status
  check                 Run heartbeat checks
  note <text>           Quick note to today's log
  idea <text>           Capture an idea for later
  learn <text>          Capture a lesson learned (not just activity)
  today                 Quick context: what happened today
  week                  Weekly overview (past 7 days)
  recap [days]          30-day recap (commits, projects, highlights)
  timeline [days]       Visual timeline of work (--commits for git)
  morning               Morning briefing (weather, priorities, yesterday)
  project [name]        List projects or show project context
  standup [--post]      Generate standup summary (optionally post to Discord)
  task <cmd> [args]     Task management (list/add/done/start/block)
  summary [--post]      Generate daily summary
  post <channel> <msg>  Post to Discord (logs/tasks)
  compress [days]       Analyze old logs for compression
  index                 Rebuild search index
  maintain              Run auto-maintenance
  analytics             Search analytics
  reflect [days]        Reflection prompts
  test                  Run toolkit tests
  goals                 Show goal status
  todo [query|count]    Find all unchecked TODOs across workspace
  triage [cat|summary]  Categorize TODOs: blocked/actionable/documentation/stale
  changelog [opts]      Generate changelog (--project, --days, --format md)
  streak [days]         Work streak & activity heatmap (default 60 days)
  pipeline [opts]       Sales pipeline funnel + health (--priority, --industry, --actions)
  month [YYYY-MM]       Monthly retrospective (--save to file, --json)
  blockers [project]    Unified blocker dashboard (--short, --json)
  git [repo]            Multi-repo git dashboard (--short, --json)
  diff [opts]           What changed? Workspace changelog (--hours, --days, --since)
  deps [project]        Dependency health dashboard (--short, --json)
  wins [days]           Recent accomplishments (--week, --project, --json)
  health                 Workspace health dashboard (--short, --json)
  focus [project]        Project focus mode â€” resume context for any project
  context [project]      Auto-generate project context doc (--save, --json)
  shield [opts]          Security scanner (--quick, --fix, --json)
  clean [opts]           Workspace hygiene scanner (--fix, --short, --json)
  snip [cmd] [args]      Code snippet library (save/get/search/tag/stats)
  env [project]          Env variable audit (--drift, --shared, --security, --short)
  pulse [opts]           Live service health monitor (--short, --history, --watch N, --json)
  fortune [opts]         Wisdom from your past self (--all, --category, --stats, --search, --add)
  orbit [opts]           Weekly momentum tracker (--short, --json, --weeks N)

Examples:
  arc search "database issue"
  arc note "figured out the bug"
  arc idea "what if leads had confidence scores"
  arc task done "memory search"
  arc summary --post
`;

function run(script, args = []) {
  const scriptPath = join(__dirname, script);
  const proc = spawn('node', [scriptPath, ...args], {
    stdio: 'inherit',
    cwd: process.cwd()
  });
  
  proc.on('close', (code) => {
    process.exit(code || 0);
  });
}

// CLI
const [,, cmd, ...args] = process.argv;

if (!cmd || cmd === 'help' || cmd === '--help' || cmd === '-h') {
  console.log(HELP);
  process.exit(0);
}

// special handling for some commands
switch (cmd) {
  case 'niche':
  case 'research':
    run(SCRIPTS.niche, args);
    break;
    
  case 'search':
    // use v2 TF-IDF search by default
    run('memory-search-v2.mjs', args);
    break;
    
  case 'search-v1':
    run(SCRIPTS.search, ['search', ...args]);
    break;
    
  case 'index':
    run(SCRIPTS.index, ['build']);
    break;
    
  case 'status':
  case 'check':
  case 'summary':
    run(SCRIPTS[cmd], args);
    break;
    
  case 'note':
    run(SCRIPTS.note, args);
    break;
    
  case 'idea':
    run(SCRIPTS.idea, args);
    break;
    
  case 'learn':
    run(SCRIPTS.learn, args);
    break;
    
  case 'today':
    run(SCRIPTS.today, args);
    break;
    
  case 'week':
    run(SCRIPTS.week, args);
    break;
    
  case 'recap':
    run(SCRIPTS.recap, args);
    break;
    
  case 'timeline':
  case 'tl':
    run(SCRIPTS.timeline, args);
    break;
    
  case 'morning':
  case 'gm':
    run(SCRIPTS.morning, args);
    break;
    
  case 'project':
  case 'proj':
    run(SCRIPTS.project, args);
    break;
    
  case 'standup':
    run(SCRIPTS.standup, args);
    break;
    
  case 'task':
    run(SCRIPTS.task, args);
    break;
    
  case 'post':
    run(SCRIPTS.post, args);
    break;
    
  case 'compress':
    run(SCRIPTS.compress, args);
    break;
    
  case 'maintain':
  case 'maintenance':
    run(SCRIPTS.maintain, args);
    break;
    
  case 'analytics':
  case 'stats':
    run(SCRIPTS.analytics, args);
    break;
    
  case 'reflect':
  case 'review':
    run(SCRIPTS.reflect, args);
    break;
    
  case 'test':
    run(SCRIPTS.test, args);
    break;
    
  case 'goals':
    run(SCRIPTS.goals, args);
    break;
    
  case 'todo':
  case 'todos':
    run(SCRIPTS.todo, args);
    break;
    
  case 'changelog':
  case 'cl':
    run(SCRIPTS.changelog, args);
    break;
    
  case 'streak':
    run(SCRIPTS.streak, args);
    break;
    
  case 'triage':
    run(SCRIPTS.triage, args);
    break;

  case 'pipeline':
  case 'pipe':
  case 'sales':
    run(SCRIPTS.pipeline, args);
    break;

  case 'git':
  case 'repos':
    run(SCRIPTS.git, args);
    break;

  case 'month':
    run(SCRIPTS.month, args);
    break;

  case 'blockers':
    run(SCRIPTS.blockers, args);
    break;

  case 'deps':
  case 'dependencies':
    run(SCRIPTS.deps, args);
    break;

  case 'wins':
  case 'achievements':
    run(SCRIPTS.wins, args);
    break;

  case 'health':
    run(SCRIPTS.health, args);
    break;

  case 'context':
  case 'ctx':
    run(SCRIPTS.context, args);
    break;

  case 'diff':
  case 'changes':
    run(SCRIPTS.diff, args);
    break;

  case 'shield':
  case 'security':
    run(SCRIPTS.shield, args);
    break;

  case 'focus':
    run(SCRIPTS.focus, args);
    break;

  case 'clean':
  case 'tidy':
  case 'sweep':
    run(SCRIPTS.clean, args);
    break;

  case 'snip':
  case 'snippet':
  case 'snippets':
    run(SCRIPTS.snip, args);
    break;

  case 'env':
  case 'envs':
    run(SCRIPTS.env, args);
    break;

  case 'pulse':
  case 'ping':
  case 'uptime':
    run(SCRIPTS.pulse, args);
    break;

  case 'fortune':
  case 'wisdom':
    run(SCRIPTS.fortune, args);
    break;

  case 'orbit':
  case 'momentum':
    run(SCRIPTS.orbit, args);
    break;

  default:
    console.log(`unknown command: ${cmd}`);
    console.log('run "arc help" for usage');
    process.exit(1);
}
