{
  "snippets": {
    "rls-helper": {
      "content": "-- NOTE: Must use public schema, not auth (supabase restricts auth schema)\nCREATE OR REPLACE FUNCTION public.get_user_org_id()\nRETURNS UUID\nLANGUAGE SQL\nSTABLE\nSECURITY DEFINER\nSET search_path = public\nAS $$\n  SELECT org_id FROM public.users WHERE id = auth.uid()",
      "source": "projects/anivia/supabase/migrations/003_fix_rls_recursion_v2.sql",
      "lineRange": "6-14",
      "startLine": 6,
      "lang": "sql",
      "tags": [
        "rls",
        "pattern",
        "sql",
        "supabase"
      ],
      "description": "SECURITY DEFINER function to break RLS recursion",
      "savedAt": "2026-02-12T00:02:58.137Z",
      "lines": 9
    },
    "supabase-admin": {
      "content": "import { createClient } from \"@supabase/supabase-js\";\n\n// Admin client with service role - bypasses RLS\n// Only use server-side!\nexport function createAdminClient() {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n  if (!supabaseUrl || !serviceRoleKey) {\n    throw new Error(\"Missing Supabase admin credentials\");\n  }\n\n  return createClient(supabaseUrl, serviceRoleKey, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  });\n}",
      "source": "projects/anivia/src/lib/supabase/admin.ts",
      "lineRange": null,
      "startLine": 1,
      "lang": "typescript",
      "tags": [
        "typescript",
        "supabase",
        "rls"
      ],
      "description": "service-role client bypassing RLS (server-side only)",
      "savedAt": "2026-02-12T00:03:02.104Z",
      "lines": 19
    },
    "hmac-token": {
      "content": "/**\n * HMAC-signed unsubscribe tokens.\n * \n * Prevents cross-org abuse — only valid tokens generated by the app\n * can trigger unsubscribe. Token format: base64url(email) + \".\" + hex(HMAC)\n */\n\nimport { createHmac, timingSafeEqual } from \"crypto\";\n\nfunction getSecret(): string {\n  const secret = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!secret) throw new Error(\"Missing signing secret\");\n  return secret;\n}\n\n/**\n * Generate a signed unsubscribe token for an email address.\n */\nexport function createUnsubscribeToken(email: string): string {\n  const data = Buffer.from(email.toLowerCase()).toString(\"base64url\");\n  const sig = createHmac(\"sha256\", getSecret())\n    .update(`unsubscribe:${data}`)\n    .digest(\"hex\");\n  return `${data}.${sig}`;\n}\n\n/**\n * Verify an unsubscribe token and extract the email.\n * Returns the email if valid, null if tampered.\n */\nexport function verifyUnsubscribeToken(token: string): string | null {\n  const dotIndex = token.lastIndexOf(\".\");\n  if (dotIndex === -1) return null;\n\n  const data = token.slice(0, dotIndex);\n  const sig = token.slice(dotIndex + 1);\n\n  const expectedSig = createHmac(\"sha256\", getSecret())\n    .update(`unsubscribe:${data}`)\n    .digest(\"hex\");\n\n  // Constant-time comparison\n  try {\n    const a = Buffer.from(sig, \"hex\");\n    const b = Buffer.from(expectedSig, \"hex\");\n    if (a.length !== b.length || !timingSafeEqual(a, b)) return null;\n  } catch {\n    return null;\n  }\n\n  try {\n    return Buffer.from(data, \"base64url\").toString();\n  } catch {\n    return null;\n  }\n}",
      "source": "projects/anivia/src/lib/unsubscribe-token.ts",
      "lineRange": null,
      "startLine": 1,
      "lang": "typescript",
      "tags": [
        "typescript",
        "security",
        "crypto",
        "pattern"
      ],
      "description": "HMAC-signed tokens with timing-safe verify — reusable pattern",
      "savedAt": "2026-02-12T00:03:05.115Z",
      "lines": 56
    },
    "unsubscribe-api": {
      "content": "import { NextResponse } from \"next/server\";\nimport { createAdminClient } from \"@/lib/supabase/admin\";\nimport { verifyUnsubscribeToken } from \"@/lib/unsubscribe-token\";\n\n/**\n * POST /api/unsubscribe\n * \n * Marks a lead as unsubscribed:\n * 1. Sets unsubscribed_at on the lead\n * 2. Pauses all active sequence enrollments for this lead\n * \n * No auth required (link from email footer).\n * Requires a signed token to prevent cross-org abuse.\n */\nexport async function POST(request: Request) {\n  const body = await request.json().catch(() => ({}));\n\n  // Prefer signed token; fall back to raw email for backward compat\n  let email: string | null = null;\n\n  if (body.token) {\n    email = verifyUnsubscribeToken(body.token);\n    if (!email) {\n      return NextResponse.json({ error: \"Invalid or expired token\" }, { status: 400 });\n    }\n  } else if (body.email && typeof body.email === \"string\") {\n    // Legacy support — log warning, will be removed\n    console.warn(\"Unsubscribe called with raw email (unsigned). Migrate to token-based.\");\n    email = body.email;\n  }\n\n  if (!email) {\n    return NextResponse.json({ error: \"Token required\" }, { status: 400 });\n  }\n\n  const supabase = createAdminClient();\n\n  // Find the lead\n  const { data: leads } = await supabase\n    .from(\"leads\")\n    .select(\"id\")\n    .eq(\"email\", email.toLowerCase());\n\n  if (!leads || leads.length === 0) {\n    // Still return OK — don't leak whether email exists\n    return NextResponse.json({ ok: true });\n  }\n\n  const leadIds = leads.map((l) => l.id);\n\n  // Mark leads as unsubscribed\n  await supabase\n    .from(\"leads\")\n    .update({ unsubscribed_at: new Date().toISOString() })\n    .in(\"id\", leadIds);\n\n  // Pause all active enrollments for these leads\n  await supabase\n    .from(\"sequence_enrollments\")\n    .update({ status: \"paused\", paused_at: new Date().toISOString() })\n    .in(\"lead_id\", leadIds)\n    .eq(\"status\", \"active\");\n\n  return NextResponse.json({ ok: true });\n}",
      "source": "projects/anivia/src/app/api/unsubscribe/route.ts",
      "lineRange": null,
      "startLine": 1,
      "lang": "typescript",
      "tags": [
        "typescript",
        "api",
        "async",
        "supabase",
        "nextjs"
      ],
      "description": "Safe unsubscribe endpoint — no auth, token-verified, no data leaks",
      "savedAt": "2026-02-12T00:03:10.819Z",
      "lines": 65
    },
    "rls-pattern": {
      "content": "ALTER TABLE campaigns ENABLE ROW LEVEL SECURITY;\nALTER TABLE campaign_sequences ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"Users can view own org campaigns\"\n  ON campaigns FOR SELECT TO authenticated\n  USING (org_id IN (SELECT org_id FROM users WHERE id = auth.uid()));\n\nCREATE POLICY \"Admins can manage campaigns\"\n  ON campaigns FOR ALL TO authenticated\n  USING (org_id IN (SELECT org_id FROM users WHERE id = auth.uid()))\n  WITH CHECK (org_id IN (SELECT org_id FROM users WHERE id = auth.uid()));\n\nCREATE POLICY \"Users can view campaign sequences\"\n  ON campaign_sequences FOR SELECT TO authenticated\n  USING (campaign_id IN (SELECT id FROM campaigns WHERE org_id IN (SELECT org_id FROM users WHERE id = auth.uid())));\n\nCREATE POLICY \"Admins can manage campaign sequences\"\n  ON campaign_sequences FOR ALL TO authenticated\n  USING (campaign_id IN (SELECT id FROM campaigns WHERE org_id IN (SELECT org_id FROM users WHERE id = auth.uid())))\n  WITH CHECK (campaign_id IN (SELECT id FROM campaigns WHERE org_id IN (SELECT org_id FROM users WHERE id = auth.uid())));",
      "source": "projects/anivia/supabase/migrations/024_campaigns.sql",
      "lineRange": "25-44",
      "startLine": 25,
      "lang": "sql",
      "tags": [
        "rls",
        "pattern",
        "sql",
        "supabase",
        "ddl"
      ],
      "description": "Standard org-scoped RLS: table + junction table policies",
      "savedAt": "2026-02-12T00:03:17.084Z",
      "lines": 20
    }
  },
  "version": 1
}